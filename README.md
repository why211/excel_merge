# Excel 文件处理工具 v2.4

一个功能强大的 Excel 文件处理工具，支持多文件数据合并、智能列名匹配、字段选择、去重处理和学生姓名补充功能。

## 🎯 核心功能

### 主要特性

-   **多文件数据合并**：支持同时处理多个 Excel 文件
-   **智能列名匹配**：自动识别和匹配不同格式的列名
-   **字段顺序保持**：按照用户选择的顺序输出字段到 Excel
-   **智能字段选择**：按出现频率排序，支持分页浏览
-   **数据去重**：支持基于多个字段的去重处理
-   **学生姓名补充**：自动根据学号匹配补充学生姓名

### 🧠 智能列名匹配功能（v2.4 新增）

-   **精确匹配**：直接匹配完全相同的列名
-   **变体匹配**：支持常见列名变体（如：学号号 → 学号，xuehao→ 学号）
-   **模糊匹配**：基于字符串相似度算法进行智能匹配
-   **列名清理**：自动去除空格、特殊字符等干扰因素
-   **用户确认**：模糊匹配时提供用户确认机制
-   **配置灵活**：可调整相似度阈值和匹配策略

## 📋 工作流程

### 1. 智能匹配配置

-   启用/禁用智能列名匹配
-   配置自动列名清理功能
    举例：
    去除首尾空格：" 学号 " → "学号"
    合并多个空格："学生 姓名" → "学生 姓名"
    移除特殊字符："学生姓名（中文）" → "学生姓名中文"

-   设置相似度阈值（0.0-1.0）

### 2. 文件选择

-   输入包含 Excel 文件的文件夹路径
-   选择要处理的文件（支持单选、多选或全选）
-   自动过滤临时文件（如~$开头的文件）

### 3. 字段分析

-   系统自动分析所有文件的字段结构
-   显示每个文件包含的字段数量
-   自动清理列名（如果启用）

### 4. 字段选择

-   按出现频率排序显示所有可用字段
-   支持分页浏览和搜索
-   选择需要导入的字段
-   **字段顺序保持**：按照用户选择的顺序输出

### 5. 学生姓名补充配置（可选）

-   系统自动检测是否需要学生姓名补充
-   显示分析结果（包含学号的文件、缺少姓名的文件等）
-   配置默认学生姓名值
-   构建学号到学生姓名的映射关系

### 6. 去重配置（可选）

-   选择是否启用去重功能
-   选择去重字段（支持单字段、多字段或全部字段）

### 7. 输出设置

-   设置输出文件名和路径

### 8. 数据处理

-   **智能列名映射**：自动匹配和映射列名
-   **字段顺序重排**：按照用户选择顺序排列字段
-   自动合并所有文件数据
-   执行学生姓名补充（如果启用）
-   执行去重处理（如果启用）

### 9. 结果导出

-   导出到 Excel 文件，包含多个工作表：
    -   **合并数据**：处理后的主要数据（按用户选择顺序排列字段）
    -   **处理统计**：详细的处理统计信息
    -   **字段信息**：字段类型和空值统计

## 🧠 智能列名匹配详解

### 匹配策略

1. **精确匹配**：优先进行完全相同的列名匹配
2. **变体匹配**：使用预定义的列名变体映射
    ```python
    common_column_variants = {
        '学号': ['学号', '学号号', '学学号', 'xuehao', 'student_id'],
        '学生姓名': ['学生姓名', '学生姓名名', 'student_name', '姓名'],
        '班级': ['班级', '班', 'class', '班级名称'],
        '成绩': ['成绩', '分数', 'score', 'grade'],
        '课程': ['课程', '科目', 'course', 'subject']
    }
    ```
3. **模糊匹配**：使用 `difflib.SequenceMatcher` 计算字符串相似度
4. **用户确认**：模糊匹配时提示用户确认

### 列名清理

-   去除首尾空格
-   合并多个空格为单个空格
-   移除特殊字符（保留中文、英文、数字）

### 配置选项

-   **启用智能匹配**：控制是否使用智能列名匹配
-   **自动清理列名**：控制是否自动清理列名
-   **相似度阈值**：设置模糊匹配的相似度阈值（默认 0.8）

## 📊 输出文件说明

### 合并数据工作表

包含所有处理后的数据记录，**字段按照用户选择的顺序排列**

### 处理统计工作表

| 统计项目             | 说明                     |
| -------------------- | ------------------------ |
| 总记录数             | 最终输出的记录总数       |
| 处理文件数           | 参与处理的文件数量       |
| 选择字段数           | 用户选择的字段数量       |
| 是否去重             | 是否启用了去重功能       |
| 去重字段数           | 去重使用的字段数量       |
| 删除重复记录数       | 去重删除的记录数量       |
| 是否启用学生姓名补充 | 是否启用了学生姓名补充   |
| 成功匹配学生姓名数   | 成功匹配的学生姓名数量   |
| 使用默认学生姓名数   | 使用默认值的学生姓名数量 |
| 学生姓名补充成功率   | 补充成功的百分比         |
| 智能匹配配置         | 智能匹配的设置信息       |
| 处理时间             | 处理完成的时间戳         |

### 字段信息工作表

| 字段名称   | 字段类型 | 非空值数量 | 空值数量   |
| ---------- | -------- | ---------- | ---------- |
| 各字段信息 | 数据类型 | 有效数据量 | 缺失数据量 |

## 🧪 测试用例

### 支持的列名格式

1. **标准格式**：`学号`、`学生姓名`
2. **多字格式**：`学号号`、`学生姓名名`
3. **错位格式**：`学学号`、`学学生姓名`
4. **颠倒格式**：`学生姓名`、`学号`（顺序不同）
5. **空格格式**：`学号`、`学生姓名 `
6. **拼音格式**：`xuehao`、`student_name`
7. **大小写格式**：`学号`、`Student_Name`
8. **特殊字符格式**：`学号`、`学生姓名（中文）`
9. **额外列格式**：包含其他字段的文件
10. **混合格式**：多种格式的组合

### 测试结果

-   **v2.3 版本**：只有标准格式文件能成功匹配（约 10%成功率）
-   **v2.4 版本**：所有格式文件都能成功匹配（100%成功率）

## 📦 安装要求

```bash
pip install pandas openpyxl
```

## 🚀 使用方法

### 基本使用

```bash
python excel_merger.py
```

### 测试智能匹配功能

```bash
# 生成测试文件
python generate_test_data.py

# 运行程序测试
python excel_merger.py
# 选择文件夹: test_excel_files
# 选择字段: 学号,学生姓名
```

## 📝 使用示例

### 输入文件示例

-   `01_标准格式_学号学生姓名.xlsx`：标准格式
-   `02_多字格式_学号号学生姓名名.xlsx`：多字格式
-   `06_拼音格式_xuehao_student_name.xlsx`：拼音格式

### 处理结果

-   自动识别和匹配所有格式的列名
-   按照用户选择的顺序输出字段
-   统一列名为标准格式
-   合并所有数据并去重

## ⚠️ 注意事项

1. **文件格式**：支持.xlsx 和.xls 格式
2. **字段名称**：支持多种格式的列名，智能匹配
3. **数据一致性**：确保学号格式一致，避免匹配失败
4. **文件权限**：确保有读取源文件和写入目标文件的权限
5. **内存使用**：处理大量文件时注意内存使用情况
6. **临时文件**：自动跳过 Excel 临时文件（~$开头的文件）

## 📈 版本历史

### v2.4 (当前版本)

-   ✅ 新增智能列名匹配功能
-   ✅ 支持字段顺序保持
-   ✅ 增强列名清理功能
-   ✅ 提供用户确认机制
-   ✅ 100%列名匹配成功率

### v2.3

-   ✅ 多文件数据合并
-   ✅ 智能字段选择
-   ✅ 数据去重功能
-   ✅ 学生姓名补充功能

### v2.0

-   ✅ 基础 Excel 处理功能
-   ✅ 多工作表输出

## 🛠️ 技术支持

如有问题或建议，请查看测试文件或联系开发者。

## 📁 项目结构

```
python/
├── excel_merger.py              # 主程序文件
├── excel_processor.py           # 处理器类
├── generate_test_data.py        # 测试数据生成器
├── test_excel_files/            # 测试文件目录
│   ├── 01_标准格式_学号学生姓名.xlsx
│   ├── 02_多字格式_学号号学生姓名名.xlsx
│   └── ...
├── README.md                    # 项目说明文档
├── README_enhanced_matching.md  # 智能匹配功能说明
└── test_report_enhanced.md      # 测试报告
```
